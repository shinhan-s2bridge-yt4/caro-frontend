<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
  * { margin: 0; padding: 0; }
  html, body { width: 100%; height: 100%; overflow: hidden; }
  #map { width: 100%; height: 100%; }
</style>
</head>
<body>
<div id="map"></div>

<script>
  // URL 파라미터에서 값 읽기
  var params = new URLSearchParams(window.location.search);
  var appKey = params.get('key') || '';
  var startAddr = params.get('start') || '';
  var endAddr = params.get('end') || '';
  var coordsRaw = params.get('coords') || '[]';
  var COORDS = [];
  try { COORDS = JSON.parse(coordsRaw); } catch(e) { COORDS = []; }

  // SDK 로드
  var script = document.createElement('script');
  script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + appKey + '&libraries=services&autoload=false';
  script.onload = function() {
    kakao.maps.load(function() {
      var container = document.getElementById('map');
      var map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.978),
        level: 5
      });

      var bounds = new kakao.maps.LatLngBounds();

      function makeSvgMarker(color) {
        var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="44" viewBox="0 0 32 44">'
          + '<path d="M16 0C7.163 0 0 7.163 0 16c0 12 16 28 16 28s16-16 16-28C32 7.163 24.837 0 16 0z" fill="' + color + '"/>'
          + '<circle cx="16" cy="16" r="7" fill="white"/>'
          + '</svg>';
        return new kakao.maps.MarkerImage(
          'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg),
          new kakao.maps.Size(32, 44),
          { offset: new kakao.maps.Point(16, 44) }
        );
      }

      // GPS 좌표가 2개 이상이면 폴리라인 + 좌표 기반 마커
      if (COORDS && COORDS.length >= 2) {
        var path = [];
        for (var i = 0; i < COORDS.length; i++) {
          var ll = new kakao.maps.LatLng(COORDS[i].lat, COORDS[i].lng);
          path.push(ll);
          bounds.extend(ll);
        }
        new kakao.maps.Polyline({
          map: map,
          path: path,
          strokeWeight: 4,
          strokeColor: '#4880ED',
          strokeOpacity: 0.8,
          strokeStyle: 'solid'
        });
        new kakao.maps.Marker({ map: map, position: path[0], image: makeSvgMarker('#4880ED') });
        new kakao.maps.Marker({ map: map, position: path[path.length - 1], image: makeSvgMarker('#FF8585') });
        map.setBounds(bounds, 80, 80, 80, 80);
      } else {
        // 좌표 없으면 기존 주소 기반 마커
        var geocoder = new kakao.maps.services.Geocoder();
        var count = 0;

        function placePin(address, color) {
          geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
              new kakao.maps.Marker({
                map: map,
                position: coords,
                image: makeSvgMarker(color)
              });
              bounds.extend(coords);
              count++;
              if (count >= 2) {
                map.setBounds(bounds, 80, 80, 80, 80);
              }
            }
          });
        }

        if (startAddr) placePin(startAddr, '#4880ED');
        if (endAddr) placePin(endAddr, '#FF8585');

        // 마커가 하나만 찍힌 경우 대비
        setTimeout(function() {
          if (count === 1) {
            map.setBounds(bounds, 80, 80, 80, 80);
          }
        }, 3000);
      }
    });
  };
  script.onerror = function() {
    document.getElementById('map').innerHTML =
      '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#FF5252;font-size:13px;font-family:sans-serif;padding:20px;text-align:center;">'
      + '카카오맵 SDK 로드 실패<br>카카오 개발자 콘솔에서<br>카카오맵 API 활성화를 확인하세요'
      + '</div>';
  };
  document.head.appendChild(script);
</script>
</body>
</html>
